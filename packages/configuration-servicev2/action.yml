name: 'Get global configuration'
description: 'Get the global configuration and secrets from Azure KeyVault'
inputs:
  environment:
    required: true
    description: Get the configuration for the specified environment
  debug:
    required: false
    type: boolean
    default: false
    description: Flag to debug this action, default is false

runs:
  using: "composite"
  steps:

    - name: Get service metadata from pom.xml
      shell: bash
      run: |
        echo " "
        echo "Configuration for environment: ${{ inputs.environment }} "
        echo " "
        echo "**************************************"
        echo "Getting service metadata from pom.xml "
        echo "**************************************"
        echo " "

        echo "Install XMLStarlet in Ubuntu"
        sudo apt-get install xmlstarlet --fix-missing        
        echo " "

        echo "xmlstarlet --version"
        xmlstarlet --version
        echo " "

        echo "Get info from pom.xml"
        servicename=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:name" pom.xml )
        serviceversion=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:version" pom.xml )
        servicegroup=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:groupId" pom.xml )
        serviceartifact=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:artifactId" pom.xml )
        echo " "

        echo "Create environment variables with pom data"
        echo "service_name=$servicename" >> $GITHUB_ENV
        echo "service_version=$serviceversion" >> $GITHUB_ENV
        echo "service_group=$servicegroup" >> $GITHUB_ENV
        echo "service_artifact=$serviceartifact" >> $GITHUB_ENV
        echo " "
        echo " "
        echo "Variables generated based on pom.xml:"
        echo "  service_name= "$servicename
        echo "  service_version= "$serviceversion          
        echo "  service_group= "$servicegroup
        echo "  service_artifact= "$serviceartifact
        echo " "

    - name: Get configuration files
      uses: btfacrm/common-devops/packages/get-file@main
      with:
        file: "$GLOBAL_CONFIGURATION $service_name.yml"

    - name: Import variables from _global.yml
      uses: zlatko-ms/envarfiles@main
      with:
        paths: "$GLOBAL_CONFIGURATION"

    - name: Get configuration parameters for the service
      shell: bash
      run: |
        echo " "
        echo "***************************************************"
        echo "Get variables fronm the global configuration file  "
        echo "***************************************************"
        echo " "
        section=".settings"
        echo "Getting the configuration for the section: $section"
        pathdata=$(cat "$GLOBAL_CONFIGURATION" | yq -r "${{ inputs.yaml-path}}")
        if [ "$pathdata" = "null" ] ; then
          echo "The yaml path was not found"; exit -1
        fi
        echo "exporting variable: $section"
        echo "configuration_settings=$pathdata" >> $GITHUB_ENV
        echo "configuration_settings=$pathdata"
        echo "test.."

    - name: DEBUG - Show variables
      shell: bash
      run: |
        echo " "
        echo "*********************************************"      
        echo "DEBUG variables"
        echo "*********************************************"
        echo " "
        echo "configuration_settings: $configuration_settings"