name: 'Get global configuration'
description: 'Get the global configuration and secrets from Azure KeyVault'
inputs:
  environment:
    required: true
    description: Get the configuration for the specified environment
  debug:
    required: false
    type: boolean
    default: false
    description: Flag to debug this action, default is false

runs:
  using: "composite"
  steps:

    - name: Get service metadata from pom.xml
      shell: bash
      run: |
        echo " "
        echo "Configuration for environment: ${{ inputs.environment }} "
        echo " "
        echo "**************************************"
        echo "Getting service metadata from pom.xml "
        echo "**************************************"
        echo " "

        echo "Install XMLStarlet in Ubuntu"
        sudo apt-get install xmlstarlet --fix-missing        
        echo " "

        echo "xmlstarlet --version"
        xmlstarlet --version
        echo " "

        echo "Get info from pom.xml"
        servicename=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:name" pom.xml )
        serviceversion=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:version" pom.xml )
        servicegroup=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:groupId" pom.xml )
        serviceartifact=$( xmlstarlet sel -N x=http://maven.apache.org/POM/4.0.0 -t -v "/x:project/x:artifactId" pom.xml )
        echo " "

        echo "Create environment variables with pom data"
        echo "service_name=$servicename" >> $GITHUB_ENV
        echo "service_version=$serviceversion" >> $GITHUB_ENV
        echo "service_group=$servicegroup" >> $GITHUB_ENV
        echo "service_artifact=$serviceartifact" >> $GITHUB_ENV
        echo " "
        echo " "
        echo "Variables generated based on pom.xml:"
        echo "  service_name= "$servicename
        echo "  service_version= "$serviceversion          
        echo "  service_group= "$servicegroup
        echo "  service_artifact= "$serviceartifact
        echo " "

    - name: Get configuration files
      uses: btfacrm/common-devops/packages/get-file@main
      with:
        file: "$GLOBAL_CONFIGURATION $service_name.yml"

    - name: Import variables from _global.yml
      uses: zlatko-ms/envarfiles@main
      with:
        paths: "$GLOBAL_CONFIGURATION"

    - name: Get configuration parameters for the service
      shell: bash
      run: |
        echo " "
        echo "***************************************************"
        echo "Get variables fronm the global configuration file  "
        echo "***************************************************"
        echo " "

        function parse_yaml {
          # echo "  Getting the configuration for the section: $1"
          pathdata=$(cat "$service_name.yml" | yq -r "$1")
          if [ "$pathdata" = "null" ] ; then
            echo "  The yaml path was not found"; exit -1
          fi
          echo "$pathdata"
        }
        
        echo "configuration_settings=$(parse_yaml '.settings')" >> $GITHUB_ENV
        echo "configuration_skiptest=$(parse_yaml '.skiptests')" >> $GITHUB_ENV
        echo "configuration_deployable=$(parse_yaml '.deployable')" >> $GITHUB_ENV

    - name: DEBUG - Show variables
      shell: bash
      run: |
        echo " "
        echo "*********************************************"      
        echo "DEBUG variables"
        echo "*********************************************"
        echo " "
        echo "Configuration variables:"
        echo "  configuration_settings= " $configuration_settings
        echo "  configuration_skiptest= " $configuration_skiptest          
        echo "  configuration_unittest= " $configuration_unittest
        echo "  configuration_deployable= " $configuration_deployable
        echo "  configuration_cloudhub= " $configuration_cloudhub
        echo "  configuration_properties= " $configuration_properties
        echo "  configuration_deployment_name= " $configuration_deployment_name
        echo "  configuration_deployment_organization= " $configuration_deployment_organization
        echo "  configuration_deployment_host= " $configuration_deployment_host
        echo "  configuration_deployment_customlogger= " $configuration_deployment_customlogger
        echo "  configuration_deployment_type= " $configuration_deployment_type
        echo "  configuration_env= " $configuration_env