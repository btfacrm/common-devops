name: 'Get global configuration'
description: 'Get the global configuration and secrets from Azure KeyVault'
inputs:
  keyvault-key:
    required: true
    description: The name of the KeyVault
  azure-credentials:
    required: true
    description: Azure Credentials for login
  environment:
    required: true
    description: Get the configuration the the specified environment
    type: choice
    options:
    - dev
    - tst
    - prd
    - unit-test
  debug:
    required: false
    type: boolean
    default: false
    description: Flag to debug this action, default is false

runs:
  using: "composite"
  steps:

    - name: DEBUG - Show action variables
      if: inputs.debug == 'true'
      shell: bash
      run: |
        echo " "
        echo "*********************************************"      
        echo "DEBUG variables"
        echo "*********************************************"
        echo " "
    
        tempvar=$( echo "${{ inputs.azure-credentials }}" | sed 's/./& /g' )
        echo "Value for inputs.azure-credentials: $tempvar"
        echo "  keyvault-key: ${{ inputs.keyvault-key }}"
        echo "  configurations-repository: $CONFIGURATIONS_REPOSITORY"
        echo "  environment: ${{ inputs.environment }}"

    # Note: if not sure if azure-credentials variable is not well configured, then try github action:
    # dmitriybobrovskiy/get-azure-keyvault-secrets, will show more details when authenticating 

    - name: DEBUG - Authentication with Azure
      if: inputs.debug == 'true'
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azure-credentials }}
 
    - name: DEBUG - Run Azure CLI
      shell: bash
      if: inputs.debug == 'true'
      run: |
        az version

    - name: Get the access token to read files on configuration repository
      uses: dmitriybobrovskiy/get-azure-keyvault-secrets@v1.2.0
      with:
        login_credentials: ${{ inputs.azure-credentials }}
        keyvault: '${{ inputs.keyvault-key }}' # The name of KeyVault in Azure
        secrets: |
          github_admintasks_accesstoken=github-admintasks-accesstoken

    - name: DEBUG - Show action variables
      if: inputs.debug == 'true'
      shell: bash
      run: |
        echo " "
        echo "*********************************************"      
        echo "DEBUG variables"
        echo "*********************************************"
        echo " "
    
        tempvar=$( echo "$github_admintasks_accesstoken" | sed 's/./& /g' )
        echo "Value for github_admintasks_accesstoken: $tempvar"
        echo " "
        echo " "

    - name: Get secrets configuration
      env:
        SECRET_MAP_FILE: _secrets.env 
      shell: bash
      run: |
        echo " "
        echo "*********************************************"
        echo "Get the configuration for secrets"
        echo "*********************************************"
    
        echo "Variable. github_admintasks_accesstoken: $github_admintasks_accesstoken"
    
        # Get the secrets mapping
        urlconfigurationfile="https://raw.githubusercontent.com/${{ github.repository_owner }}/$CONFIGURATIONS_REPOSITORY/main/$SECRET_MAP_FILE"
        echo "Getting the secrets mapping file: $urlconfigurationfile"
        initialsecretconfiguration=$(curl -sH "Authorization: token $github_admintasks_accesstoken" $urlconfigurationfile)
    
        temporal=""
        echo "$initialsecretconfiguration" | while read p; do
          if [[ "$p" =~ ^#.*  ]]; then
            echo "   A comment found"
          else
            temporal=$(echo "$temporal $p")
            echo "   Variable found: $p"
          fi
          echo "$temporal" > configurationmap.txt
        done 
    
        echo ""
        configurationmap=$(cat configurationmap.txt)
        echo "Configuration file to get the secrets: $configurationmap"
        
        # Enable only for debug
        # echo "initialsecretconfiguration: $initialsecretconfiguration"
        echo ""
    
    - name: Get Azure KeyVault
      uses: dmitriybobrovskiy/get-azure-keyvault-secrets@v1.2.0
      with:
        keyvault: '${{ inputs.keyvault-key }}' # The name of KeyVault in Azure
        secrets_file_path: configurationmap.txt